<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalogue Home</title>
    <link rel="stylesheet" th:href="@{/style.css}">

</head>
<body>
    <nav class="site-nav">
        <div class="nav-inner">
            <div class="brand">Customised Gifts</div>
            <ul class="nav-links">
                <li><a th:href="@{/}" class="active">Our Products</a></li>
                <li><a href="about.html">About Us</a></li>
                <li><a href="contact.html">Contact Us</a></li>
            </ul>
        </div>
    </nav>

    <main class="catalogue-only" id="products">
        <h1 class="catalogue-title">Our Products</h1>
        <ul class="catalog-grid" aria-label="Product list">
            <li th:each="product : ${products}" class="catalog-card" th:data-product-id="${product.id}">
                <div class="media">
                    <img th:if="${product.imageUrl != null and product.imageUrl != ''}" 
                         th:src="${product.imageUrl}" 
                         th:alt="${product.name}" 
                         loading="lazy">
                    <img th:unless="${product.imageUrl != null and product.imageUrl != ''}" 
                         src="laptop.jpg" 
                         th:alt="${product.name}" 
                         loading="lazy">
                </div>
                <div class="info">
                    <h2 class="name" th:text="${product.name}">Product Name</h2>
                    <p class="desc" th:text="${product.description}">Product description</p>
                    <span class="price" th:aria-label="|Price ${product.price} Rupees|" 
                          th:text="|â‚¹${#numbers.formatDecimal(product.price, 1, 2)}|">â‚¹0</span>
                    <button type="button"
                       class="whatsapp-btn action" 
                       th:data-product-name="${product.name}"
                       th:data-product-price="${#numbers.formatDecimal(product.price, 1, 2)}"
                       th:data-product-description="${product.description}"
                       th:data-product-category="${product.category.name}"
                       th:aria-label="|Buy ${product.name} on WhatsApp|"
                       onclick="openWhatsAppFromButton(this)">Buy on WhatsApp</button>
                </div>
            </li>
            
            <!-- Show message if no products -->
            <li th:if="${#lists.isEmpty(products)}" class="catalog-card no-products">
                <div class="info" style="text-align: center; padding: 2rem;">
                    <h2 class="name">No Products Available</h2>
                    <p class="desc">Please check the admin panel to add products.</p>
                    <a href="admin" class="whatsapp-btn action">Go to Admin Panel</a>
                </div>
            </li>
        </ul>
    </main>

    <footer>
        <p>&copy; 2025 WhatsApp Business Catalogue</p>
    </footer>

    <!-- WhatsApp Integration Script -->
    <script th:inline="javascript">
        // Configuration from backend
        const BUSINESS_WHATSAPP = /*[[${whatsappNumber}]]*/ '+919876543210';
        const BUSINESS_NAME = /*[[${businessName}]]*/ 'Customised Gifts Store';
        
        // Function to open WhatsApp from button click
        function openWhatsAppFromButton(button) {
            const productName = button.dataset.productName;
            const productPrice = button.dataset.productPrice;
            const productDescription = button.dataset.productDescription;
            const categoryName = button.dataset.productCategory;
            
            // Create the message with product details
            const message = `Hi ${BUSINESS_NAME}! ðŸ‘‹

I'm interested in purchasing this product from your catalog:

*${productName}*
ðŸ’° Price: â‚¹${productPrice}
ðŸ“‚ Category: ${categoryName}

${productDescription}

Could you please provide more details about:
âœ… Availability
âœ… Delivery options
âœ… Payment methods

Thank you! ðŸ˜Š`;

            // Encode the message for URL
            const encodedMessage = encodeURIComponent(message);
            
            // Create WhatsApp URLs
            const whatsappWebUrl = `https://web.whatsapp.com/send?phone=${BUSINESS_WHATSAPP}&text=${encodedMessage}`;
            const whatsappAppUrl = `whatsapp://send?phone=${BUSINESS_WHATSAPP}&text=${encodedMessage}`;
            
            // Try WhatsApp app first on all devices, then fallback to web
            // Try to open WhatsApp app first
            globalThis.location.href = whatsappAppUrl;
            
            // If the app doesn't open (not installed or doesn't respond), 
            // fallback to WhatsApp Web after a short delay
            setTimeout(() => {
                globalThis.open(whatsappWebUrl, '_blank');
            }, 1500);
            
            // Track the click for analytics
            trackWhatsAppClick(productName, productPrice);
        }
        
        // Enhanced desktop WhatsApp handling with user preference
        function tryDesktopWhatsApp(encodedMessage) {
            const desktopUrl = `whatsapp://send?phone=${BUSINESS_WHATSAPP}&text=${encodedMessage}`;
            const webUrl = `https://web.whatsapp.com/send?phone=${BUSINESS_WHATSAPP}&text=${encodedMessage}`;
            
            // Check if user has a saved preference
            const savedPreference = localStorage.getItem('whatsapp-preference');
            
            if (savedPreference === 'desktop') {
                openWhatsAppDesktop(desktopUrl, webUrl);
            } else if (savedPreference === 'web') {
                globalThis.open(webUrl, '_blank');
            } else {
                // First time - ask user preference
                showWhatsAppChoiceModal(desktopUrl, webUrl);
            }
        }
        
        // Show choice modal for first-time users
        function showWhatsAppChoiceModal(desktopUrl, webUrl) {
            const choice = confirm(
                'ðŸ“± Choose your preferred WhatsApp option:\n\n' +
                'âœ… OK = WhatsApp Desktop App (if installed)\n' +
                'âŒ Cancel = WhatsApp Web (browser)\n\n' +
                'Your choice will be remembered for future clicks.'
            );
            
            if (choice) {
                localStorage.setItem('whatsapp-preference', 'desktop');
                openWhatsAppDesktop(desktopUrl, webUrl);
            } else {
                localStorage.setItem('whatsapp-preference', 'web');
                globalThis.open(webUrl, '_blank');
            }
        }
        
        // Open WhatsApp Desktop with fallback
        function openWhatsAppDesktop(desktopUrl, webUrl) {
            // Try desktop app
            globalThis.location.href = desktopUrl;
            
            // Fallback to web if desktop doesn't respond
            setTimeout(() => {
                globalThis.open(webUrl, '_blank');
            }, 2500);
        }
        
        // Alternative: Direct approach without confirmation
        function openWhatsAppDirect(encodedMessage) {
            const desktopUrl = `whatsapp://send?phone=${BUSINESS_WHATSAPP}&text=${encodedMessage}`;
            const webUrl = `https://web.whatsapp.com/send?phone=${BUSINESS_WHATSAPP}&text=${encodedMessage}`;
            
            // Try desktop first, then fallback to web
            globalThis.location.href = desktopUrl;
            
            // Fallback timer for web version
            setTimeout(() => {
                globalThis.open(webUrl, '_blank');
            }, 2000);
        }
        
        // Mobile detection function
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // Analytics tracking function
        function trackWhatsAppClick(productName, productPrice) {
            console.log(`WhatsApp inquiry: ${productName} - â‚¹${productPrice}`);
            
            // Google Analytics 4 event tracking (if available)
            if (typeof gtag !== 'undefined') {
                gtag('event', 'whatsapp_inquiry', {
                    'product_name': productName,
                    'product_price': productPrice,
                    'event_category': 'ecommerce'
                });
            }
            
            // Facebook Pixel tracking (if available)
            if (typeof fbq !== 'undefined') {
                fbq('track', 'Contact', {
                    content_name: productName,
                    value: productPrice,
                    currency: 'INR'
                });
            }
        }
        
        // Add visual feedback when buttons are clicked
        document.addEventListener('DOMContentLoaded', function() {
            const whatsappButtons = document.querySelectorAll('.whatsapp-btn');
            for (const button of whatsappButtons) {
                button.addEventListener('click', function() {
                    // Add clicked effect
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 150);
                });
            }
            
            // Add preference reset option (right-click on any WhatsApp button)
            for (const button of whatsappButtons) {
                button.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    if (confirm('Reset WhatsApp preference? You\'ll be asked to choose again next time.')) {
                        localStorage.removeItem('whatsapp-preference');
                        alert('WhatsApp preference reset! You\'ll be asked to choose on your next click.');
                    }
                });
            }
        });
        
        // Global function to reset WhatsApp preference (can be called from console)
        function resetWhatsAppPreference() {
            localStorage.removeItem('whatsapp-preference');
            alert('WhatsApp preference reset!');
        }
    </script>
</body>
</html>